name: Build Release Assets

on:
  workflow_run:
    workflows: ["Release"]
    types: [completed]

permissions:
  contents: write

jobs:
  # Get the latest release tag
  get-release:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    outputs:
      tag: ${{ steps.get-tag.outputs.tag }}
      has_release: ${{ steps.get-tag.outputs.has_release }}
    steps:
      - name: Get latest release tag
        id: get-tag
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG=$(gh release list --repo ${{ github.repository }} --limit 1 --json tagName -q '.[0].tagName')
          if [ -n "$TAG" ]; then
            echo "tag=$TAG" >> $GITHUB_OUTPUT
            echo "has_release=true" >> $GITHUB_OUTPUT
            echo "Latest release: $TAG"
          else
            echo "has_release=false" >> $GITHUB_OUTPUT
            echo "No releases found"
          fi

  # Build standalone tarballs for each platform
  build-tarballs:
    needs: get-release
    if: ${{ needs.get-release.outputs.has_release == 'true' }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            targets: linux-x64,linux-arm64
          - os: macos-latest
            targets: darwin-x64,darwin-arm64
          - os: windows-latest
            targets: win32-x64,win32-arm64
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install

      - name: Build
        run: pnpm build

      - name: Pack tarballs
        run: pnpm exec oclif pack tarballs --targets=${{ matrix.targets }}

      - name: Upload Release Assets
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        shell: bash
        run: |
          for file in dist/*.tar.gz dist/*.tar.xz; do
            if [ -f "$file" ]; then
              gh release upload "${{ needs.get-release.outputs.tag }}" "$file" --clobber
            fi
          done

  # Build Debian packages (.deb) for apt install
  build-deb:
    needs: get-release
    if: ${{ needs.get-release.outputs.has_release == 'true' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install

      - name: Build
        run: pnpm build

      - name: Pack deb
        run: pnpm exec oclif pack deb

      - name: Upload Release Assets
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          for file in dist/deb/*.deb; do
            if [ -f "$file" ]; then
              gh release upload "${{ needs.get-release.outputs.tag }}" "$file" --clobber
            fi
          done

  # Build Windows installer (.exe)
  build-windows:
    needs: get-release
    if: ${{ needs.get-release.outputs.has_release == 'true' }}
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'pnpm'

      - name: Install NSIS
        run: choco install nsis -y

      - name: Install dependencies
        run: pnpm install

      - name: Build
        run: pnpm build

      - name: Pack Windows installer
        run: pnpm exec oclif pack win

      - name: Upload Release Assets
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        shell: bash
        run: |
          for file in dist/win32/*.exe; do
            if [ -f "$file" ]; then
              gh release upload "${{ needs.get-release.outputs.tag }}" "$file" --clobber
            fi
          done

  # Build macOS installer (.pkg) - unsigned for now
  build-macos:
    needs: get-release
    if: ${{ needs.get-release.outputs.has_release == 'true' }}
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install

      - name: Build
        run: pnpm build

      - name: Pack macOS installer
        run: pnpm exec oclif pack macos

      - name: Upload Release Assets
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          for file in dist/macos/*.pkg; do
            if [ -f "$file" ]; then
              gh release upload "${{ needs.get-release.outputs.tag }}" "$file" --clobber
            fi
          done
