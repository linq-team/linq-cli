name: Build Release Assets

on:
  workflow_run:
    workflows: ["Release"]
    types: [completed]
  workflow_dispatch:  # Allow manual trigger

permissions:
  contents: write

jobs:
  # Get the latest release tag
  get-release:
    runs-on: ubuntu-latest
    if: ${{ github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success' }}
    outputs:
      tag: ${{ steps.get-tag.outputs.tag }}
      has_release: ${{ steps.get-tag.outputs.has_release }}
    steps:
      - name: Get latest release tag
        id: get-tag
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG=$(gh release list --repo ${{ github.repository }} --limit 1 --json tagName -q '.[0].tagName')
          if [ -n "$TAG" ]; then
            echo "tag=$TAG" >> $GITHUB_OUTPUT
            echo "has_release=true" >> $GITHUB_OUTPUT
            echo "Latest release: $TAG"
          else
            echo "has_release=false" >> $GITHUB_OUTPUT
            echo "No releases found"
          fi

  # Build Debian packages (.deb) for apt install
  build-deb:
    needs: get-release
    if: ${{ needs.get-release.outputs.has_release == 'true' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install

      - name: Build
        run: pnpm build

      - name: Pack deb
        run: pnpm exec oclif pack deb

      - name: Upload Release Assets
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          for file in dist/deb/*.deb; do
            if [ -f "$file" ]; then
              gh release upload "${{ needs.get-release.outputs.tag }}" "$file" --clobber
            fi
          done

  # Build Windows installer (.exe)
  build-windows:
    needs: get-release
    if: ${{ needs.get-release.outputs.has_release == 'true' }}
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'pnpm'

      - name: Install NSIS
        run: choco install nsis -y

      - name: Install dependencies
        run: pnpm install

      - name: Build
        run: pnpm build

      - name: Pack Windows installer
        shell: bash
        run: |
          # Use Git's GNU tar (Windows tar doesn't support --force-local)
          # Also add NSIS to PATH for makensis command
          export PATH="/c/Program Files/Git/usr/bin:/c/Program Files (x86)/NSIS:$PATH"
          ./node_modules/.bin/oclif pack win

      - name: Upload Release Assets
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        shell: bash
        run: |
          for file in dist/win32/*.exe; do
            if [ -f "$file" ]; then
              gh release upload "${{ needs.get-release.outputs.tag }}" "$file" --clobber
            fi
          done

  # Build macOS installer (.pkg) - unsigned for now
  build-macos:
    needs: get-release
    if: ${{ needs.get-release.outputs.has_release == 'true' }}
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install

      - name: Build
        run: pnpm build

      - name: Pack macOS installer
        run: pnpm exec oclif pack macos

      - name: Upload Release Assets
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          for file in dist/macos/*.pkg; do
            if [ -f "$file" ]; then
              gh release upload "${{ needs.get-release.outputs.tag }}" "$file" --clobber
            fi
          done
