name: Publish Release Assets

on:
  workflow_run:
    workflows: ["Release"]
    types: [completed]
  workflow_dispatch:  # Allow manual trigger

permissions:
  contents: write

jobs:
  get-release:
    runs-on: ubuntu-latest
    if: ${{ github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success' }}
    outputs:
      tag: ${{ steps.get-tag.outputs.tag }}
    steps:
      - name: Get latest release tag
        id: get-tag
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG=$(gh release list --repo ${{ github.repository }} --limit 1 --json tagName -q '.[0].tagName')
          if [ -n "$TAG" ]; then
            echo "tag=$TAG" >> $GITHUB_OUTPUT
            echo "Latest release: $TAG"
          else
            echo "No releases found"
            exit 1
          fi

  build-installers:
    needs: get-release
    uses: ./.github/workflows/build-installers.yml
    with:
      tag: ${{ needs.get-release.outputs.tag }}
    secrets: inherit

  update-homebrew:
    needs: get-release
    runs-on: ubuntu-latest
    steps:
      - name: Update Homebrew formula
        env:
          GH_TOKEN: ${{ secrets.HOMEBREW_TAP_TOKEN }}
        run: |
          TAG="${{ needs.get-release.outputs.tag }}"
          VERSION="${TAG#v}"

          # Get sha256 of the source tarball
          SHA256=$(curl -sL "https://github.com/${{ github.repository }}/archive/refs/tags/${TAG}.tar.gz" | shasum -a 256 | awk '{print $1}')
          echo "Version: ${VERSION}"
          echo "SHA256: ${SHA256}"

          # Clone the tap repo
          git clone "https://x-access-token:${GH_TOKEN}@github.com/linq-team/homebrew-tap.git"
          cd homebrew-tap

          # Generate the formula
          mkdir -p Formula
          cat > Formula/linq.rb << FORMULA
          class Linq < Formula
            desc "CLI for the Linq messaging API (iMessage, SMS)"
            homepage "https://linqapp.com"
            url "https://github.com/linq-team/linq-cli/archive/refs/tags/v${VERSION}.tar.gz"
            sha256 "${SHA256}"
            license "Apache-2.0"

            livecheck do
              url :stable
              strategy :github_latest
            end

            depends_on "node@22"

            def install
              system "npm", "install", *std_npm_args(prefix: false)
              system "npm", "run", "build"
              system "npx", "oclif", "manifest"
              system "npm", "prune", "--omit=dev"

              libexec.install Dir["*"]
              bin.install_symlink libexec/"bin/run.js" => "linq"
            end

            test do
              assert_match version.to_s, shell_output("#{bin}/linq --version")
              assert_match "chats", shell_output("#{bin}/linq help")
            end
          end
          FORMULA

          # Remove leading whitespace from heredoc indentation
          sed -i 's/^          //' Formula/linq.rb

          # Commit and push
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Formula/linq.rb
          if git diff --staged --quiet; then
            echo "No changes to formula"
          else
            git commit -m "linq ${VERSION}"
            git push
          fi
